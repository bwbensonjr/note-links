<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Note Links</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    [v-cloak] { display: none; }
    .tag { transition: all 0.15s ease; }
    .tag:hover { transform: translateY(-1px); }
    .filter-panel-enter-active,
    .filter-panel-leave-active {
      transition: all 0.2s ease;
      overflow: hidden;
    }
    .filter-panel-enter-from,
    .filter-panel-leave-to {
      opacity: 0;
      max-height: 0;
      padding-top: 0;
      padding-bottom: 0;
    }
    .filter-panel-enter-to,
    .filter-panel-leave-from {
      opacity: 1;
      max-height: 300px;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="app" v-cloak>
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
      <div class="max-w-6xl mx-auto px-4 py-4">
        <h1 class="text-2xl font-bold text-gray-800">Note Links</h1>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 py-6">
      <!-- Compact Search Bar -->
      <div class="bg-white rounded-lg shadow-sm border p-3 mb-4">
        <!-- Single row: Search + Sort + Filters button -->
        <div class="flex items-center gap-3">
          <!-- Search -->
          <div class="flex-1">
            <input
              v-model="searchQuery"
              type="text"
              placeholder="Search links..."
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
            >
          </div>

          <!-- Sort -->
          <select
            v-model="sortBy"
            class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white"
          >
            <option value="date_desc">Newest</option>
            <option value="date_asc">Oldest</option>
            <option value="title_asc">Title A-Z</option>
            <option value="title_desc">Title Z-A</option>
            <option value="domain_asc">Domain</option>
          </select>

          <!-- Filters Toggle Button -->
          <button
            @click="showFilters = !showFilters"
            class="relative px-4 py-2 border rounded-lg hover:bg-gray-50 transition flex items-center gap-2"
            :class="{ 'bg-blue-50 border-blue-300': showFilters || activeFilterCount > 0 }"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
            </svg>
            <span>Filters</span>
            <span
              v-if="activeFilterCount > 0"
              class="absolute -top-1 -right-1 bg-blue-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center"
            >
              {{ activeFilterCount }}
            </span>
          </button>
        </div>

        <!-- Collapsible Filter Panel -->
        <transition name="filter-panel">
          <div v-show="showFilters" class="mt-4 pt-4 border-t">
            <div class="flex flex-wrap gap-4 items-end">
              <!-- Tag Filter -->
              <div class="flex-1 min-w-48">
                <label class="block text-sm font-medium text-gray-700 mb-1">Tags</label>
                <select
                  v-model="selectedTags"
                  multiple
                  class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none h-24"
                >
                  <option v-for="tag in allTags" :key="tag.name" :value="tag.name">
                    {{ tag.name }} ({{ tag.count }})
                  </option>
                </select>
              </div>

              <!-- Domain Filter -->
              <div class="flex-1 min-w-48">
                <label class="block text-sm font-medium text-gray-700 mb-1">Domain</label>
                <select
                  v-model="selectedDomain"
                  class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                >
                  <option value="">All domains</option>
                  <option v-for="domain in allDomains" :key="domain.domain" :value="domain.domain">
                    {{ domain.domain }} ({{ domain.count }})
                  </option>
                </select>
              </div>

              <!-- Date Range -->
              <div class="flex-1 min-w-48">
                <label class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                <div class="flex gap-2">
                  <input
                    v-model="dateFrom"
                    type="date"
                    class="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                  >
                  <input
                    v-model="dateTo"
                    type="date"
                    class="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                  >
                </div>
              </div>

              <!-- Clear Filters -->
              <button
                @click="clearFilters"
                class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition"
              >
                Clear all
              </button>
            </div>
          </div>
        </transition>

        <!-- Active Filters Display (always visible when filters are active) -->
        <div v-if="activeFilterCount > 0 && !showFilters" class="mt-3 flex flex-wrap gap-2">
          <span
            v-for="tag in selectedTags"
            :key="tag"
            class="inline-flex items-center px-2 py-1 bg-blue-100 text-blue-800 text-sm rounded-full"
          >
            {{ tag }}
            <button @click="removeTag(tag)" class="ml-1 hover:text-blue-600">&times;</button>
          </span>
          <span
            v-if="selectedDomain"
            class="inline-flex items-center px-2 py-1 bg-green-100 text-green-800 text-sm rounded-full"
          >
            {{ selectedDomain }}
            <button @click="selectedDomain = ''" class="ml-1 hover:text-green-600">&times;</button>
          </span>
          <span
            v-if="dateFrom || dateTo"
            class="inline-flex items-center px-2 py-1 bg-purple-100 text-purple-800 text-sm rounded-full"
          >
            {{ dateFrom || '...' }} to {{ dateTo || '...' }}
            <button @click="dateFrom = ''; dateTo = ''" class="ml-1 hover:text-purple-600">&times;</button>
          </span>
        </div>
      </div>

      <!-- Results Count -->
      <div class="mb-4 text-gray-600 text-sm">
        Showing {{ paginatedLinks.length }} of {{ filteredLinks.length }} links
        <span v-if="totalPages > 1"> (page {{ currentPage }} of {{ totalPages }})</span>
      </div>

      <!-- Loading State -->
      <div v-if="loading" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-500 border-t-transparent"></div>
        <p class="mt-2 text-gray-600">Loading links...</p>
      </div>

      <!-- Error State -->
      <div v-else-if="error" class="text-center py-12">
        <p class="text-red-600">{{ error }}</p>
        <p class="text-gray-500 mt-2">Make sure data.json exists in the same directory.</p>
      </div>

      <!-- Links List -->
      <div v-else class="space-y-4">
        <article
          v-for="link in paginatedLinks"
          :key="link.id"
          class="bg-white rounded-lg shadow-sm border p-4 hover:shadow-md transition"
        >
          <!-- Title and Domain -->
          <div class="flex items-start justify-between gap-4">
            <a
              :href="link.url"
              target="_blank"
              rel="noopener noreferrer"
              class="text-lg font-medium text-blue-600 hover:text-blue-800 hover:underline flex-1"
            >
              {{ link.page_title || link.title || link.description || link.url }}
            </a>
            <span class="text-sm text-gray-500 whitespace-nowrap">{{ link.domain }}</span>
          </div>

          <!-- Description -->
          <p v-if="link.description" class="mt-2 text-gray-600 text-sm">
            {{ truncate(link.description, 200) }}
          </p>

          <!-- Summary -->
          <p v-if="link.summary" class="mt-2 text-gray-700">
            {{ truncate(link.summary, 300) }}
          </p>

          <!-- Tags and Date -->
          <div class="mt-3 flex flex-wrap items-center gap-2">
            <span class="text-sm text-gray-500">{{ link.source_date }}</span>
            <span
              v-for="tag in link.tags"
              :key="tag"
              @click="addTagFilter(tag)"
              class="tag px-2 py-0.5 bg-gray-100 text-gray-700 text-xs rounded-full cursor-pointer hover:bg-blue-100 hover:text-blue-800"
            >
              {{ tag }}
            </span>
          </div>
        </article>

        <!-- Empty State -->
        <div v-if="filteredLinks.length === 0 && !loading" class="text-center py-12">
          <p class="text-gray-500">No links match your filters.</p>
        </div>
      </div>

      <!-- Pagination -->
      <div v-if="totalPages > 1" class="mt-6 flex justify-center gap-2">
        <button
          @click="currentPage = 1"
          :disabled="currentPage === 1"
          class="px-3 py-1 rounded border hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          First
        </button>
        <button
          @click="currentPage--"
          :disabled="currentPage === 1"
          class="px-3 py-1 rounded border hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Prev
        </button>
        <span class="px-3 py-1">{{ currentPage }} / {{ totalPages }}</span>
        <button
          @click="currentPage++"
          :disabled="currentPage === totalPages"
          class="px-3 py-1 rounded border hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Next
        </button>
        <button
          @click="currentPage = totalPages"
          :disabled="currentPage === totalPages"
          class="px-3 py-1 rounded border hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Last
        </button>
      </div>
    </main>

    <!-- Footer -->
    <footer class="mt-12 py-6 border-t bg-white">
      <div class="max-w-6xl mx-auto px-4 text-center text-gray-500 text-sm">
        <span v-if="exportedAt">Last updated: {{ formatDate(exportedAt) }}</span>
      </div>
    </footer>
  </div>

  <script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
      setup() {
        // Data
        const links = ref([]);
        const allTags = ref([]);
        const allDomains = ref([]);
        const exportedAt = ref(null);
        const loading = ref(true);
        const error = ref(null);

        // Filters
        const searchQuery = ref("");
        const selectedTags = ref([]);
        const selectedDomain = ref("");
        const dateFrom = ref("");
        const dateTo = ref("");
        const sortBy = ref("date_desc");

        // UI State
        const showFilters = ref(false);

        // Pagination
        const currentPage = ref(1);
        const perPage = 25;

        // Load data
        onMounted(async () => {
          try {
            const response = await fetch("data.json");
            if (!response.ok) throw new Error("Failed to load data.json");
            const data = await response.json();
            links.value = data.links || [];
            // Sort tags alphabetically
            allTags.value = (data.all_tags || []).sort((a, b) => a.name.localeCompare(b.name));
            // Only include domains with more than one link
            allDomains.value = (data.all_domains || []).filter(d => d.count > 1);
            exportedAt.value = data.exported_at;
          } catch (e) {
            error.value = e.message;
          } finally {
            loading.value = false;
          }
        });

        // Computed: filtered and sorted links
        const filteredLinks = computed(() => {
          let result = [...links.value];

          // Search filter
          if (searchQuery.value.trim()) {
            const query = searchQuery.value.toLowerCase();
            result = result.filter(link =>
              (link.title || "").toLowerCase().includes(query) ||
              (link.description || "").toLowerCase().includes(query) ||
              (link.summary || "").toLowerCase().includes(query) ||
              (link.page_title || "").toLowerCase().includes(query)
            );
          }

          // Tag filter (AND logic - must have all selected tags)
          if (selectedTags.value.length > 0) {
            result = result.filter(link =>
              selectedTags.value.every(tag => link.tags.includes(tag))
            );
          }

          // Domain filter
          if (selectedDomain.value) {
            result = result.filter(link => link.domain === selectedDomain.value);
          }

          // Date range filter
          if (dateFrom.value) {
            result = result.filter(link => link.source_date >= dateFrom.value);
          }
          if (dateTo.value) {
            result = result.filter(link => link.source_date <= dateTo.value);
          }

          // Sort
          result.sort((a, b) => {
            switch (sortBy.value) {
              case "date_desc":
                return (b.source_date || "").localeCompare(a.source_date || "");
              case "date_asc":
                return (a.source_date || "").localeCompare(b.source_date || "");
              case "title_asc":
                return (a.page_title || a.title || "").localeCompare(b.page_title || b.title || "");
              case "title_desc":
                return (b.page_title || b.title || "").localeCompare(a.page_title || a.title || "");
              case "domain_asc":
                return (a.domain || "").localeCompare(b.domain || "");
              default:
                return 0;
            }
          });

          return result;
        });

        // Computed: total pages
        const totalPages = computed(() => Math.ceil(filteredLinks.value.length / perPage));

        // Computed: paginated links
        const paginatedLinks = computed(() => {
          const start = (currentPage.value - 1) * perPage;
          return filteredLinks.value.slice(start, start + perPage);
        });

        // Computed: count of active filters (for badge)
        const activeFilterCount = computed(() => {
          let count = 0;
          count += selectedTags.value.length;
          if (selectedDomain.value) count++;
          if (dateFrom.value || dateTo.value) count++;
          return count;
        });

        // Methods
        const clearFilters = () => {
          searchQuery.value = "";
          selectedTags.value = [];
          selectedDomain.value = "";
          dateFrom.value = "";
          dateTo.value = "";
          currentPage.value = 1;
        };

        const removeTag = (tag) => {
          selectedTags.value = selectedTags.value.filter(t => t !== tag);
        };

        const addTagFilter = (tag) => {
          if (!selectedTags.value.includes(tag)) {
            selectedTags.value = [...selectedTags.value, tag];
            currentPage.value = 1;
          }
        };

        const truncate = (text, length) => {
          if (!text || text.length <= length) return text;
          return text.slice(0, length) + "...";
        };

        const formatDate = (isoString) => {
          return new Date(isoString).toLocaleDateString();
        };

        return {
          // Data
          links,
          allTags,
          allDomains,
          exportedAt,
          loading,
          error,
          // Filters
          searchQuery,
          selectedTags,
          selectedDomain,
          dateFrom,
          dateTo,
          sortBy,
          // UI State
          showFilters,
          // Pagination
          currentPage,
          totalPages,
          // Computed
          filteredLinks,
          paginatedLinks,
          activeFilterCount,
          // Methods
          clearFilters,
          removeTag,
          addTagFilter,
          truncate,
          formatDate,
        };
      }
    }).mount("#app");
  </script>
</body>
</html>
